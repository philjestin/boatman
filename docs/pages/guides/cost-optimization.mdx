# Cost Optimization

Strategies for reducing Claude API costs while maintaining quality.

## Model Selection

The single most impactful optimization is choosing the right model per agent:

### Default (Balanced)

```yaml
claude:
  models:
    planner: claude-sonnet-4-5
    executor: claude-sonnet-4-5
    reviewer: claude-sonnet-4-5
    refactor: claude-sonnet-4-5
    preflight: claude-haiku-4      # 90% cheaper
    test_runner: claude-haiku-4    # 90% cheaper
```

### Cost-Optimized

```yaml
claude:
  models:
    planner: claude-sonnet-4-5     # Needs good planning
    executor: claude-sonnet-4-5    # Needs good code generation
    reviewer: claude-haiku-4       # Simple pass/fail + issues
    refactor: claude-haiku-4       # Targeted fixes
    preflight: claude-haiku-4      # Fast validation
    test_runner: claude-haiku-4    # Simple output parsing
```

### Maximum Quality

```yaml
claude:
  models:
    planner: claude-opus-4-6
    executor: claude-opus-4-6
    reviewer: claude-opus-4-6
    refactor: claude-opus-4-6
    preflight: claude-haiku-4
    test_runner: claude-haiku-4
```

---

## Prompt Caching

Enable prompt caching to reduce costs by 50-90% on repeated context:

```yaml
claude:
  enable_prompt_caching: true   # Default: true
```

This is especially effective for:
- Multiple review/refactor iterations on the same codebase
- Batch processing of similar tasks
- Retrying failed workflows

---

## Reduce Review Iterations

Fewer iterations = fewer API calls:

### Lenient Reviews
```yaml
max_iterations: 3
review:
  max_critical_issues: 2
  max_major_issues: 5
```

This passes reviews more easily, reducing the number of refactor cycles.

### Skip Review Entirely (Development Only)
For prototyping where you'll review manually:

```yaml
max_iterations: 1
```

---

## Token Budget Tuning

Smaller handoffs = lower costs:

```yaml
token_budget:
  context: 4000    # Reduced from 8000
  plan: 1000       # Reduced from 2000
  review: 2000     # Reduced from 4000
```

Trade-off: Smaller budgets may miss relevant context, potentially causing more iterations.

---

## Feature Toggles

Disable features you don't need:

```yaml
enable_preflight: false      # Skip plan validation
enable_tests: false          # Skip test running
enable_diff_verify: false    # Skip diff verification
enable_memory: false         # Skip cross-session learning
```

Each disabled feature saves one agent invocation per workflow.

---

## Workflow Strategies

### Quick Prototype Mode
```yaml
max_iterations: 1
enable_preflight: false
enable_tests: false
enable_diff_verify: false
claude:
  models:
    planner: claude-haiku-4
    executor: claude-sonnet-4-5
    reviewer: claude-haiku-4
    refactor: claude-haiku-4
    preflight: claude-haiku-4
    test_runner: claude-haiku-4
```

### Production Mode
```yaml
max_iterations: 5
enable_preflight: true
enable_tests: true
enable_diff_verify: true
claude:
  models:
    planner: claude-sonnet-4-5
    executor: claude-sonnet-4-5
    reviewer: claude-sonnet-4-5
    refactor: claude-sonnet-4-5
    preflight: claude-haiku-4
    test_runner: claude-haiku-4
```

---

## Monitoring Costs

Use the built-in cost tracking:

```bash
export BOATMAN_DEBUG=1
boatman work --prompt "Add feature"
```

Debug output includes token counts per agent invocation.

---

## Cost Comparison

| Configuration | Approximate Cost per Task |
|--------------|--------------------------|
| Maximum quality (all Opus) | High |
| Balanced (all Sonnet) | Medium |
| Cost-optimized (mixed) | Low |
| Quick prototype (mostly Haiku) | Minimal |

Exact costs depend on codebase size, task complexity, and number of review iterations.

---

## Platform Cost Governance

When using the [Boatman Platform](/platform), you get organizational cost governance features:

### Budget Configuration

Set daily, monthly, and per-run budgets via the API:

```bash
curl -X PUT http://localhost:8080/api/v1/costs/budget \
  -H "Content-Type: application/json" \
  -H "X-Boatman-Org: my-org" \
  -d '{
    "daily_limit": 50.00,
    "monthly_limit": 500.00,
    "per_run_limit": 10.00,
    "alert_at": 0.8
  }'
```

### Budget Alerts

The platform automatically:
- Tracks cost per step via `CostHooks` integration with the runner
- Publishes `budget.alert` events when spend crosses the `alert_at` threshold
- Publishes `policy.violation` events when per-run limits are exceeded
- The `PolicyGuard` can halt runs that exceed cost limits

### Cost Dashboard

The web dashboard at `http://localhost:8080` provides:
- Real-time cost charts with configurable time grouping (hour, day, week, month)
- Per-run cost breakdowns
- Budget utilization tracking
- Historical cost summaries

See the [Platform Cost Governance](/platform/cost-governance) docs for details.
